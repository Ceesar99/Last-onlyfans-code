// components/LoadingSplash.jsx
import React, { useState, useEffect } from "react";

const LoadingSplash = ({ children }) => {
  const [stage, setStage] = useState("logo");
  const [isVisible, setIsVisible] = useState(true);
  const [pendingCount, setPendingCount] = useState(0);

  useEffect(() => {
    console.log("ðŸŽ¬ LoadingSplash mounted");
    
    // Logo shows for 2-3 seconds
    const logoTime = Math.random() * 1000 + 2000;
    const logoTimer = setTimeout(() => {
      console.log("â­ï¸ Moving to spinner stage");
      setStage("spinner");
    }, logoTime);

    // Subscribe to appLoadManager
    let unsubManager = null;
    if (typeof window !== "undefined" && window.appLoadManager) {
      const initialCount = window.appLoadManager.pendingCount();
      console.log(`ðŸ“Š Initial pending tasks: ${initialCount}`);
      setPendingCount(initialCount);
      
      unsubManager = window.appLoadManager.onChange((count) => {
        console.log(`ðŸ“Š Task count updated: ${count}`);
        setPendingCount(count);
      });
    }

    // Fallback: maximum wait so spinner won't block forever
    const globalFallbackTimer = setTimeout(() => {
      console.warn("â° Global fallback timeout - hiding splash anyway");
      setIsVisible(false);
      setStage("done");
    }, 25000); // 25s max

    return () => {
      clearTimeout(logoTimer);
      clearTimeout(globalFallbackTimer);
      if (unsubManager) unsubManager();
    };
  }, []);

  // When we are in spinner stage and pendingCount becomes 0, hide splash
  useEffect(() => {
    if (stage === "spinner" && pendingCount === 0) {
      console.log("âœ¨ All tasks complete - hiding splash");
      const hideTimer = setTimeout(() => {
        setIsVisible(false);
        setStage("done");
      }, 300); // 300ms fade delay
      return () => clearTimeout(hideTimer);
    }
    
    // Re-show spinner if new tasks appear
    if (pendingCount > 0 && !isVisible && stage === "spinner") {
      console.log("ðŸ”„ New tasks detected - showing spinner again");
      setIsVisible(true);
    }
  }, [pendingCount, stage, isVisible]);

  if (!isVisible) {
    console.log("ðŸ‘‹ LoadingSplash hidden, showing app");
    return children;
  }

  return (
    <div
      style={{
        position: "fixed",
        inset: 0,
        backgroundColor: "#fff",
        display: "flex",
        flexDirection: "column",
        justifyContent: "center",
        alignItems: "center",
        zIndex: 9999,
        transition: "opacity 0.45s ease",
        opacity: isVisible ? 1 : 0,
      }}
    >
      {stage === "logo" && (
        <div
          style={{
            width: 480,
            height: 660,
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            animation: "fadeIn 0.9s ease-out forwards",
            marginTop: "-80px",
          }}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="720"
            height="1181"
            viewBox="0 0 720 1181"
            style={{
              width: "100%",
              height: "100%",
              maxWidth: 460,
              maxHeight: 690,
              animation: "breathe 1.6s ease-in-out infinite",
              transformOrigin: "50% 50%",
              transformBox: "fill-box",
              willChange: "transform, opacity",
            }}
          >
            <g id="onlyfans-logo-2">
              <path id="15" d="M 376.861,703.275 C 376.515,702.715 375.382,696.531 375.594,696.356 C 375.680,696.284 377.325,695.708 379.250,695.077 C 381.587,694.310 383.326,693.354 384.483,692.199 C 384.483,692.199 386.216,690.469 386.216,690.469 C 386.216,690.469 385.110,689.572 385.110,689.572 C 383.580,688.332 382.474,685.545 378.675,673.363 C 373.599,657.079 372.873,654.515 373.240,654.146 C 373.428,653.958 375.853,653.804 378.632,653.804 C 378.632,653.804 383.683,653.804 383.683,653.804 C 383.683,653.804 384.279,656.306 384.279,656.306 C 387.293,668.931 390.281,680.576 390.508,680.576 C 390.661,680.576 391.651,676.466 392.709,671.444 C 393.767,666.421 395.108,660.509 395.691,658.307 C 395.691,658.307 396.750,654.304 396.750,654.304 C 396.750,654.304 402.077,654.162 402.077,654.162 C 402.077,654.162 407.406,654.021 407.406,654.021 C 407.406,654.021 406.426,657.165 406.426,657.165 C 405.888,658.894 404.010,665.038 402.253,670.818 C 398.147,684.331 395.716,691.327 394.246,693.866 C 392.520,696.848 388.856,699.994 385.149,701.676 C 381.789,703.201 377.344,704.058 376.861,703.275" stroke="#12ADED" fill="#12ADED" strokeWidth="1" />
              <path id="17" d="M 448.750,688.633 C 446.043,687.377 443.834,684.930 442.152,681.327 C 440.834,678.503 440.750,677.923 440.750,671.569 C 440.750,663.668 441.538,660.793 444.685,657.215 C 447.995,653.451 452.017,652.070 456.779,653.059 C 458.615,653.440 459.966,654.097 460.957,655.089 C 460.957,655.089 462.423,656.556 462.423,656.556 C 462.423,656.556 463.923,655.055 463.923,655.055 C 465.305,653.671 465.699,653.553 468.943,653.553 C 468.943,653.553 472.464,653.553 472.464,653.553 C 472.464,653.553 472.418,666.596 472.418,666.596 C 472.418,666.596 472.373,679.638 472.373,679.638 C 472.373,679.638 473.779,681.107 473.779,681.107 C 473.779,681.107 475.185,682.575 475.185,682.575 C 475.185,682.575 473.743,685.595 473.743,685.595 C 472.756,687.662 471.942,688.704 471.163,688.900 C 469.261,689.378 465.892,687.999 464.733,686.269 C 464.733,686.269 463.685,684.706 463.685,684.706 C 463.685,684.706 462.031,686.446 462.031,686.446 C 461.121,687.403 459.625,688.500 458.704,688.885 C 456.305,689.889 451.174,689.759 448.750,688.633M 459.212,681.375 C 461.688,680.340 462.173,678.337 461.901,670.291 C 461.726,665.122 461.485,663.363 460.812,662.334 C 459.498,660.327 457.897,659.782 455.463,660.511 C 452.399,661.430 451.525,663.721 451.511,670.881 C 451.498,677.628 451.776,679.188 453.287,680.819 C 454.625,682.265 456.634,682.453 459.212,681.375" stroke="#0085C2" fill="#0085C2" strokeWidth="1" />
              <path id="15-2" d="M 362.695,688.631 C 358.322,685.962 358,683.985 358,659.838 C 358,659.838 358,640.151 358,640.151 C 358,640.151 359.125,639.884 359.125,639.884 C 361.928,639.219 368.037,638.504 368.494,638.787 C 368.822,638.990 369,646.471 369,660.101 C 369,660.101 369,681.102 369,681.102 C 369,681.102 370.510,681.404 370.510,681.404 C 372.339,681.770 372.530,682.041 373.564,685.741 C 373.564,685.741 374.378,688.654 374.378,688.654 C 374.378,688.654 373.156,689.119 373.156,689.119 C 370.888,689.982 364.414,689.680 362.695,688.631" stroke="#12ADED" fill="#12ADED" strokeWidth="1" />
              <path id="17-2" d="M 522.510,689.035 C 519.601,688.464 514.789,686.047 514.610,685.065 C 514.532,684.643 515.185,683.216 516.061,681.893 C 517.824,679.227 517.637,679.251 522.657,681.062 C 525.979,682.261 530.224,682.529 531.875,681.644 C 533.290,680.886 533.390,678.465 532.061,677.134 C 531.544,676.617 529.576,675.686 527.686,675.063 C 520.319,672.637 517.231,670.213 516.029,665.916 C 514.988,662.197 515.663,659.368 518.197,656.833 C 520.976,654.051 523.961,653.053 529.499,653.053 C 533.941,653.053 537.726,653.888 541.112,655.614 C 541.112,655.614 542.973,656.563 542.973,656.563 C 542.973,656.563 540.918,659.562 540.918,659.562 C 539.787,661.211 538.836,662.558 538.806,662.555 C 538.775,662.551 537.324,662.101 535.581,661.554 C 532.318,660.530 527.763,660.249 526.581,660.999 C 525.466,661.706 526.147,663.708 527.903,664.890 C 528.812,665.502 530.725,666.384 532.153,666.851 C 541.114,669.780 543.769,672.288 543.727,677.787 C 543.688,683.079 540.507,687.299 535.417,688.812 C 532.605,689.647 526.199,689.758 522.510,689.035" stroke="#0085C2" fill="#0085C2" strokeWidth="1" />
              <path id="17-3" d="M 480.235,688.473 C 480.098,688.117 480.046,680.170 480.118,670.815 C 480.118,670.815 480.250,653.804 480.250,653.804 C 480.250,653.804 483.485,653.652 483.485,653.652 C 488.147,653.433 488.858,653.716 489.563,656.069 C 489.563,656.069 490.163,658.074 490.163,658.074 C 490.163,658.074 491.707,656.390 491.707,656.390 C 497.284,650.305 507.426,651.766 509.511,658.955 C 509.854,660.141 509.995,665.862 509.899,674.821 C 509.899,674.821 509.750,688.833 509.750,688.833 C 509.750,688.833 504.875,688.976 504.875,688.976 C 504.875,688.976 500,689.120 500,689.120 C 500,689.120 500,675.935 500,675.935 C 500,663.358 499.953,662.700 498.981,661.655 C 497.204,659.746 493.369,660.455 491.632,663.013 C 490.868,664.139 490.716,665.950 490.500,676.573 C 490.500,676.573 490.250,688.833 490.250,688.833 C 490.250,688.833 485.366,688.976 485.366,688.976 C 481.728,689.083 480.420,688.955 480.235,688.473" stroke="#0085C2" fill="#0085C2" strokeWidth="1" />
              <path id="15-3" d="M 291.178,689.582 C 281.397,688.149 275.432,680.281 274.669,667.808 C 273.941,655.902 277.651,648.004 285.877,643.947 C 288.495,642.656 289.767,642.365 293.682,642.160 C 297.612,641.954 298.889,642.092 301.690,643.024 C 310.014,645.797 314.872,653.008 315.377,663.341 C 315.962,675.322 312.095,683.727 304.140,687.761 C 302.276,688.707 294.421,690.431 293.839,690.022 C 293.790,689.987 292.593,689.790 291.178,689.582M 300.474,679.850 C 303.176,677.260 303.750,674.799 303.750,665.814 C 303.750,657.860 303.740,657.789 302.250,655.069 C 300.377,651.648 298.117,650.050 295.156,650.050 C 291.577,650.050 289.144,651.628 287.583,654.961 C 286.313,657.672 286.250,658.186 286.250,665.814 C 286.250,673.454 286.312,673.952 287.591,676.685 C 289.445,680.644 291.189,681.683 295.608,681.463 C 298.509,681.318 299.172,681.099 300.474,679.850" stroke="#12ADED" fill="#12ADED" strokeWidth="1" />
              <path id="1" d="M 290.591,680.590 C 289.518,679.916 288.459,678.539 287.591,676.685 C 286.312,673.952 286.250,673.454 286.250,665.814 C 286.250,658.186 286.313,657.672 287.583,654.961 C 289.144,651.628 291.577,650.050 295.156,650.050 C 298.117,650.050 300.377,651.648 302.250,655.069 C 303.740,657.789 303.750,657.860 303.750,665.814 C 303.750,674.799 303.176,677.260 300.474,679.850 C 299.172,681.099 298.509,681.318 295.608,681.463 C 292.880,681.599 291.939,681.435 290.591,680.590" stroke="#FDFDFD" fill="#FDFDFD" strokeWidth="1" />
              <path id="18" d="M 406.076,658.808 C 406.076,658.257 406.380,657.019 406.750,656.056 C 407.174,654.954 407.424,654.675 407.424,655.305 C 407.424,655.855 407.120,657.094 406.750,658.057 C 406.326,659.159 406.076,659.437 406.076,658.808" stroke="#ECF6F5" fill="#ECF6F5" strokeWidth="1" />
              <path id="18-2" d="M 396.031,655.167 C 395.990,653.661 397.700,653.036 401.658,653.112 C 407.495,653.224 408.058,653.932 402.359,653.995 C 397.262,654.051 396.943,654.115 396.515,655.180 C 396.515,655.180 396.063,656.306 396.063,656.306 C 396.063,656.306 396.031,655.167 396.031,655.167" stroke="#ECF6F5" fill="#ECF6F5" strokeWidth="1" />
              <path id="17-4" d="M 412.120,665.939 C 412.120,665.939 412.250,643.295 412.250,643.295 C 412.250,643.295 425.396,643.161 425.396,643.161 C 425.396,643.161 438.543,643.028 438.543,643.028 C 438.543,643.028 438.396,646.914 438.396,646.914 C 438.396,646.914 438.250,650.801 438.250,650.801 C 438.250,650.801 430.625,650.939 430.625,650.939 C 430.625,650.939 423,651.077 423,651.077 C 423,651.077 423,657.069 423,657.069 C 423,657.069 423,663.061 423,663.061 C 423,663.061 429.272,663.061 429.272,663.061 C 429.272,663.061 435.544,663.061 435.544,663.061 C 435.544,663.061 435.397,666.690 435.397,666.690 C 435.397,666.690 435.250,670.318 435.250,670.318 C 435.250,670.318 429.250,670.568 429.250,670.568 C 429.250,670.568 423.250,670.818 423.250,670.818 C 423.250,670.818 423.113,679.701 423.113,679.701 C 423.113,679.701 422.977,688.583 422.977,688.583 C 422.977,688.583 417.483,688.583 417.483,688.583 C 417.483,688.583 411.990,688.583 411.990,688.583 C 411.990,688.583 412.120,665.939 412.120,665.939" stroke="#0085C2" fill="#0085C2" strokeWidth="1" />
              <path id="15-4" d="M 325.750,688.618 C 325.750,688.618 321.250,688.333 321.250,688.333 C 321.250,688.333 321.118,671.243 321.118,671.243 C 321.118,671.243 320.987,654.153 320.987,654.153 C 320.987,654.153 323.966,653.808 323.966,653.808 C 328.143,653.322 329.807,653.780 330.436,655.587 C 330.717,656.395 331.162,657.056 331.423,657.056 C 331.685,657.056 333.063,656.272 334.486,655.314 C 339.133,652.185 343.820,651.807 347.530,654.264 C 350.883,656.485 351.192,657.802 351.528,671.318 C 351.692,677.924 351.810,684.455 351.788,685.831 C 351.788,685.831 351.750,688.333 351.750,688.333 C 351.750,688.333 346.375,688.475 346.375,688.475 C 346.375,688.475 341,688.617 341,688.617 C 341,688.617 340.993,675.964 340.993,675.964 C 340.984,661.663 340.835,660.904 337.981,660.661 C 336.578,660.542 335.819,660.869 334.126,662.319 C 334.126,662.319 332.017,664.125 332.017,664.125 C 332.017,664.125 331.884,676.473 331.884,676.473 C 331.769,687.033 331.642,688.826 331,688.862 C 330.587,688.885 328.225,688.775 325.750,688.618" stroke="#12ADED" fill="#12ADED" strokeWidth="1" />
              <path id="1-2" d="M 453.287,680.819 C 451.776,679.188 451.498,677.628 451.511,670.881 C 451.525,663.721 452.399,661.430 455.463,660.511 C 457.897,659.782 459.498,660.327 460.812,662.334 C 461.947,664.070 462.450,675.944 461.508,678.800 C 460.444,682.026 455.524,683.235 453.287,680.819" stroke="#FDFDFD" fill="#FDFDFD" strokeWidth="1" />
            </g>
            <g id="onlyfans-logo-1">
              <path id="15-5" d="M 195,689.789 C 190.509,688.596 187.058,686.630 183.754,683.384 C 178.803,678.522 176.500,672.847 176.500,665.511 C 176.500,654.329 183.552,645.282 194.441,642.495 C 201.004,640.815 206.898,641.513 212.486,644.632 C 214.006,645.481 215.723,646.417 216.301,646.714 C 217.337,647.244 217.327,647.286 215.665,649.603 C 214.737,650.895 212.756,654.545 211.263,657.713 C 208.786,662.969 207.500,664.978 207.500,663.593 C 207.500,663.302 206.700,662.178 205.722,661.095 C 202.811,657.870 199.390,657.804 195.958,660.907 C 192.780,663.781 192.721,667.647 195.804,671.062 C 196.739,672.098 198.136,673.072 198.907,673.227 C 200.937,673.633 203.900,672.833 205.364,671.485 C 206.475,670.462 206.569,670.441 206.125,671.318 C 205.846,671.869 204.891,675.472 204.001,679.325 C 203.111,683.178 201.972,687.288 201.470,688.458 C 200.423,690.895 199.714,691.041 195,689.789" stroke="#12ADED" fill="#12ADED" strokeWidth="1" />
              <path id="4" d="M 201.470,688.458 C 201.972,687.288 203.118,683.178 204.015,679.325 C 204.912,675.472 206.177,671.131 206.823,669.679 C 207.470,668.226 208,666.461 208,665.757 C 208,664.067 213.470,652.716 216.077,648.997 C 218.328,645.785 221.625,643.375 225.365,642.208 C 227.013,641.693 231.112,641.376 238.625,641.180 C 250.856,640.862 250.239,640.648 248.657,644.661 C 246.355,650.501 241.701,655.082 235.308,657.801 C 233.488,658.575 232,659.386 232,659.603 C 232,660.404 236.291,660.591 238.875,659.903 C 241.456,659.216 241.500,659.223 241.500,660.303 C 241.500,662.269 238.515,667.440 235.766,670.236 C 232.954,673.095 229.444,674.824 225.293,675.393 C 223.381,675.656 223.102,675.901 221.561,678.685 C 219.513,682.386 216.340,685.493 212.541,687.520 C 209.650,689.062 204.426,690.563 201.903,690.577 C 201.903,690.577 200.556,690.585 200.556,690.585 C 200.556,690.585 201.470,688.458 201.470,688.458" stroke="#008CC5" fill="#008CC5" strokeWidth="1" />
              <path id="1-3" d="M 198.750,673.213 C 197.143,672.830 194.519,669.999 193.922,668.003 C 193.078,665.184 193.735,662.917 195.984,660.883 C 198.037,659.027 200.613,658.220 202.582,658.816 C 205.186,659.606 208.007,663.306 207.992,665.914 C 207.982,667.683 206.136,670.954 204.500,672.101 C 203.144,673.052 200.346,673.593 198.750,673.213" stroke="#FDFDFD" fill="#FDFDFD" strokeWidth="1" />
            </g>
          </svg>
        </div>
      )}

      {stage === "spinner" && (
        <div
          style={{
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            gap: 16,
            animation: "fadeIn 0.6s ease-out forwards",
          }}
        >
          <div style={{ width: 48, height: 48 }}>
            <svg
              viewBox="0 0 50 50"
              style={{
                width: "100%",
                height: "100%",
                animation: "rotate 1s linear infinite",
              }}
            >
              <circle
                cx="25"
                cy="25"
                r="20"
                fill="none"
                stroke="#12ADED"
                strokeWidth="4"
                strokeLinecap="round"
                strokeDasharray="31.4 31.4"
              />
            </svg>
          </div>
          <div style={{ color: "#444", fontSize: 14 }}>
            {pendingCount > 0
              ? `Loading ${pendingCount} item${pendingCount > 1 ? "s" : ""}...`
              : "Loading..."}
          </div>
        </div>
      )}

      <style>{`
        @keyframes rotate {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        @keyframes breathe {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.06); opacity: 0.94; }
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `}</style>
    </div>
  );
};

export default LoadingSplash;
